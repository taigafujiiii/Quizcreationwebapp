# クイズアプリ テスト仕様書（本番）

## 目的
本番環境（Vercel Production）において、ユーザー機能と管理者機能、および Supabase Functions の動作を確認する。

## 対象環境
- URL: https://quiz-app-alpha-umber.vercel.app
- Supabase Project: yxvwxafwidesoqjbizbk
- テスト種別: 手動実行を想定した仕様書（後にE2E/API自動化へ移行可能）

## 前提条件
- 管理者アカウントが存在し、ログイン可能であること
- 一般ユーザーアカウントが存在し、ログイン可能であること
- `units` / `categories` / `questions` にデータが投入済みであること
- 本番環境の環境変数が設定済みであること
  - `VITE_SUPABASE_URL`
  - `VITE_SUPABASE_ANON_KEY`

## ルート一覧
- /login
- /accept-invite
- /verify
- /forgot
- /reset-password
- /
- /quiz/setup
- /quiz
- /result
- /assignment/units
- /assignment/categories/:unitId
- /admin
- /admin/units
- /admin/categories
- /admin/questions
- /admin/assignments
- /admin/users

## テストデータ
- 管理者: `education@maisonmarc.com`（role=admin）
- 一般ユーザー: 任意のユーザー（role=user）
- 既存データ: `supabase/seed.sql` の `units` / `categories` / `questions`

---

## 認証・権限

### A-01 ログイン成功（管理者）
- 手順
  1. /login で管理者メールとパスワードを入力
- 期待結果
  - ログイン成功
  - `/admin` に遷移

### A-02 ログイン成功（一般ユーザー）
- 手順
  1. /login で一般ユーザーを入力
- 期待結果
  - ログイン成功
  - `/` に遷移

### A-03 ログイン失敗（不正パスワード）
- 手順
  1. 正しいメール＋誤ったパスワードでログイン
- 期待結果
  - 失敗メッセージが表示される

### A-04 未ログイン時の保護ルート
- 手順
  1. 未ログインで `/` / `/quiz/setup` / `/admin` に直接アクセス
- 期待結果
  - `/login` にリダイレクトされる

### A-05 一般ユーザーの管理画面アクセス
- 手順
  1. 一般ユーザーでログイン
  2. `/admin` に直接アクセス
- 期待結果
  - `/` にリダイレクトされる

### A-06 ログアウト
- 手順
  1. ログイン後にログアウトを実行
- 期待結果
  - セッションが破棄され `/login` に遷移

### A-07 招待登録（有効トークン）
- 手順
  1. `/accept-invite?token=...&email=...&role=...` にアクセス
  2. ユーザー名（50文字以内）・パスワード（8文字以上）・確認を入力して送信
- 期待結果
  - 登録完了メッセージが表示される
  - `/login` に遷移

### A-08 招待登録（無効/期限切れ/使用済み）
- 手順
  1. 無効/期限切れ/使用済みトークンで `/accept-invite` にアクセス
- 期待結果
  - 状態に応じたエラーメッセージが表示され、登録できない

### A-09 メール認証（成功/失敗）
- 手順
  1. `/verify` にアクセス
- 期待結果
  - 認証中→成功 or 失敗の表示に遷移する

### A-10 パスワード再設定（申請）
- 手順
  1. `/forgot` で登録済みメールを入力して送信
- 期待結果
  - 送信完了メッセージが表示される

### A-11 パスワード再設定（更新）
- 手順
  1. `/reset-password` にアクセス
  2. 新しいパスワード（8文字以上）と確認を入力して送信
- 期待結果
  - 更新完了メッセージが表示される

### A-12 パスワード再設定（不一致/短すぎ）
- 手順
  1. `/reset-password` で確認不一致または短すぎるパスワードを入力
- 期待結果
  - バリデーションエラーが表示され送信できない

---

## ユーザー機能

### U-01 Home 画面表示
- 手順
  1. 一般ユーザーでログイン
  2. `/` を表示
- 期待結果
  - データが表示される

### U-02 クイズ開始フロー
- 手順
  1. `/quiz/setup` で条件を選択
  2. `/quiz` に遷移して出題が表示される
  3. 回答後 `/result` に遷移
- 期待結果
  - クイズが表示され、結果画面へ遷移する

### U-03 課題フロー
- 手順
  1. `/assignment/units` に移動
  2. 単元を選択
  3. `/assignment/categories/:unitId` に遷移
- 期待結果
  - 単元/カテゴリが表示される

### U-04 自由演習の単元/カテゴリ制限（user）
- 手順
  1. 一般ユーザーでログイン
  2. `/quiz/setup` を開く
- 期待結果
  - `allowedUnitIds` に含まれない単元は選択できない

### U-05 許可単元が0件の場合
- 手順
  1. `allowedUnitIds` が空のユーザーで `/quiz/setup` を開く
- 期待結果
  - 警告メッセージが表示され、出題条件を選べない

### U-06 自由演習の条件必須チェック
- 手順
  1. `/quiz/setup` で出題条件未選択のまま開始する
- 期待結果
  - バリデーションエラーが表示される

### U-07 クイズ進行（戻れない/終了確認）
- 手順
  1. `/quiz` で回答を進める
  2. 前の問題へ戻ろうとする
  3. 途中でホームへ戻る操作を行う
- 期待結果
  - 前の問題には戻れない
  - ホームへ戻る際に確認モーダルが表示される
  - 破棄を選ぶと進捗がリセットされる

### U-08 クイズ回答の選択肢（わからない含む）
- 手順
  1. `/quiz` で各問題の選択肢（A/B/C/D/わからない）を選ぶ
- 期待結果
  - 選択が反映され次の問題へ進める

### U-09 結果画面の詳細表示
- 手順
  1. クイズ完了後に `/result` を表示
- 期待結果
  - 正解数/正答率が表示される
  - 各問題の正誤/選択肢/正解/解説が表示される

### U-10 課題カテゴリが未設定の場合
- 手順
  1. `/assignment/categories/:unitId` で課題問題の無いカテゴリを選択する
- 期待結果
  - 選択不可または「課題問題なし」の表示になる

### U-11 出題数が不足する場合
- 手順
  1. 条件に合う問題数より多い出題数を選択
- 期待結果
  - 不足の警告が表示される、または出題数が調整される

---

## 管理者機能

### M-01 管理者ダッシュボード
- 手順
  1. 管理者でログインし `/admin` を表示
- 期待結果
  - 管理画面が表示される

### M-02 単元管理（CRUD）
- 手順
  1. `/admin/units` で作成・更新・削除
- 期待結果
  - DB に反映される

### M-03 カテゴリ管理（CRUD）
- 手順
  1. `/admin/categories` で作成・更新・削除
- 期待結果
  - DB に反映される

### M-04 問題管理（CRUD）
- 手順
  1. `/admin/questions` で作成・更新・削除
- 期待結果
  - DB に反映される

### M-05 課題管理
- 手順
  1. `/admin/assignments` で課題設定を操作
- 期待結果
  - DB に反映される

### M-06 ユーザー管理（招待）
- 手順
  1. `/admin/users` で招待を実行
- 期待結果
  - 招待メールが送信される

### M-07 ユーザー管理（検索/フィルタ）
- 手順
  1. `/admin/users` で検索（メール/ユーザー名）とロールフィルタを操作
- 期待結果
  - 条件に一致するユーザーのみが表示される

### M-08 ユーザー編集（ユーザー名/許可単元）
- 手順
  1. `/admin/users` でユーザーを編集
  2. ユーザー名（50文字以内）と `allowedUnitIds` を更新
- 期待結果
  - DB に反映される

### M-09 ユーザー無効化の反映
- 手順
  1. `/admin/users` でユーザーを無効化
  2. 該当ユーザーでログインを試行
- 期待結果
  - ログイン不可になる

### M-10 管理者招待の必須条件
- 手順
  1. `/admin/users` で admin/user を切り替えて招待する
- 期待結果
  - user の場合は許可単元が必須
  - admin の場合は許可単元の指定が不要

### M-11 問題の公開/非公開切替
- 手順
  1. `/admin/questions` で `isActive` を切り替える
  2. `/quiz` の出題対象を確認
- 期待結果
  - `isActive = true` の問題のみ出題される

---

## Functions（API）

### F-01 管理者ユーザー一覧取得
- 対象: `GET /functions/v1/admin/users`
- 手順
  1. 管理者でログイン
  2. 画面からユーザー一覧を表示
- 期待結果
  - 一覧が表示される

### F-02 招待API
- 対象: `POST /functions/v1/admin/invite`
- 手順
  1. 管理者で招待を実行
- 期待結果
  - 成功レスポンス
  - 招待メール送信

### F-03 ユーザー更新
- 対象: `PATCH /functions/v1/admin/users/:id`
- 手順
  1. 管理者でユーザー権限を変更
- 期待結果
  - DB が更新される

### F-04 ユーザー無効化
- 対象: `POST /functions/v1/admin/users/:id/deactivate`
- 手順
  1. 管理者で無効化
- 期待結果
  - ログイン不可になる

### F-05 非管理者の管理APIアクセス
- 対象: `GET /functions/v1/admin/users` など
- 手順
  1. 一般ユーザーのトークンでアクセス
- 期待結果
  - 403 もしくは権限エラーが返る

### F-06 不正リクエスト（必須項目不足）
- 対象: `POST /functions/v1/admin/invite` など
- 手順
  1. 必須項目を欠いたリクエストを送信
- 期待結果
  - 400 もしくはバリデーションエラーが返る

---

## 失敗系・境界

### E-01 無効なAPIキー
- 手順
  1. `VITE_SUPABASE_ANON_KEY` を誤値で起動
- 期待結果
  - `Invalid API key` が表示される

### E-02 権限不足
- 手順
  1. 一般ユーザーで管理APIにアクセス
- 期待結果
  - 403/リダイレクト

### E-03 データ空状態
- 手順
  1. `units` / `categories` / `questions` が空の状態で各画面を表示
- 期待結果
  - 空状態のメッセージが表示される

### E-04 ネットワーク/サーバーエラー
- 手順
  1. 通信エラーが発生する状況で API を実行
- 期待結果
  - 失敗メッセージが表示される

---

## 自動化候補
- E2E: ログイン、管理画面のCRUD、クイズ実行、招待/登録/パスワード再設定
- API: Functions の 4 エンドポイント
